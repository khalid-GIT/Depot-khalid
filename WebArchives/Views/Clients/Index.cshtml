@model WebArchives.Models.Clients.VMListeClient


@{
    ViewBag.Title = "Data";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            Data Tables
            <small>advanced tables</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li><a href="#">Tables</a></li>
            <li class="active">Data tables</li>
        </ol>
    </section>
    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-xs-12">

                <!-- /.box -->
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">Data Table With Full Features</h3>
                    </div>

                    <!-- /.box-header -->
                    <div class="box-body">
                        <table id="idTableClients" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Nom)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Adresse)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.FamilleName)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Tbl_Ville_id)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.IDContact)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.Mail)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.telephone1)
                                    </th>
                                    <th>
                                        Action
                                    </th>
                                </tr>
                            </thead>

                            @*<tfoot>
                                    <tr>
                                        <th>Rendering engine</th>
                                        <th>Browser</th>
                                        <th>Platform(s)</th>
                                        <th>Engine version</th>
                                        <th>CSS grade</th>
                                    </tr>
                                </tfoot>*@
                        </table>
                    </div>
                    <!-- /.box-body -->
                </div>
                <!-- /.box -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->
    </section>
    <!-- /.content -->
</div>
<!-- /.content-wrapper -->

@section Scripts
{
<script src="~/Content/LoginTlE/plugins/jquery-validation/jquery.validate.min.js"></script>

    @*<script type="text/javascript">$(document).ready(function () {
          $('#example1').DataTable()
          $('#example2').DataTable({
            'paging'      : true,
            'lengthChange': false,
            'searching'   : false,
            'ordering'    : true,
            'info'        : true,
            'autoWidth'   : false
          })
        })</script>*@

    <script type="text/javascript">
var table = null;
var err = false;
function ReloadClientTable(data) {
//alert("Hello")
    if (table != null) {
            //il y a des données  (table != null) &&
            $('#idTableClients').DataTable().destroy();
        }
        //if (!table.emptyTable) table.destroy();
        table = $('#idTableClients').DataTable({
            data,
            "columns": [
                //{ "data": "id", "title": "id", "width": "20px"},
                { "data": "Nom", "title": "Nom", "width": "30px"},
                { "data": "Adresse", "title": "Adresse", "width": "30%" },
                { "data": "FamilleName", "title": "Famille", "width": "30px" },
                //{ "data": "Tbl_Ville_id", "title": "Ville" },
                { "data": "VilleName", "title": "Ville", "width": "30px" },
                //{ "data": "IDContact","title": "Contact" },
                { "data": "ContactName", "title": "Contact", "width": "60px"},
                { "data": "Mail", "title": "Mail", "width": "20px"},
                { "data": "telephone1", "title": "Téléphone", "width": "20px"},
                //{ "title": "DatedeCreation" },
                //{ "data": "Gsm", "title": "GSM", "width": "30px"},
                {
                    "data": "id",
                    "title": "Actions",
                    "width": "25%",
                    "orderable": false,
                    "class": "center",
                    "render": function (data, type, full, meta) {
                        return "<div class='status-block'><a onclick='EditClients(" + data + ")'  style='width:30px' class='btn btn-block btn-success btn-sm' ><i class='fa-edit'></i></a><a onclick='Delete(" + data + ")' style= 'width:30px' class='btn btn-block btn-danger btn-sm'><i class='fa-remove'></i></a><a  style= 'width:30px' class='btn btn-block btn-info'><i class='fa-info'></i></a></div>";
                    }
                }
                //'" + row.id + "'
            ],
            "searching": false,
            "scrollY": "420px",
            "scrollX": true,
            "scrollCollapse": false,
            "autoWidth": false,
            //"colReorder": true,
            "language": {
                "info": "Afficher _END_ sur _TOTAL_ ",
                "lengthMenu": "Afficher _MENU_ par page",
                "paginate": {
                    "first": "Premier",
                    "last": "Dernier",
                    "next": "Suivant",
                    "previous": "Précédent"
                },
                //"emptyTabale": "Pas d'enregistrement trouvés",
                "emptyTable": "Chargement des donnée en cours, veuillez patienter ....",
                select: {
                    style: 'multi'
                },
            }
        });
}
$(document).ready(function () {

    $("#addClientForm").validate({
        errorClass: 'help-block animation-slideDown', // You can change the animation class for a different entrance animation - check animations page
        errorElement: 'div',
        errorPlacement: function (error, e) {
            e.parents('.form-group > div').append(error);
        },
        highlight: function (e) {

            $(e).closest('.form-group').removeClass('has-success has-error').addClass('has-error');
            $(e).closest('.help-block').remove();
        },
        success: function (e) {
            e.closest('.form-group').removeClass('has-success has-error');
            e.closest('.help-block').remove();
        },
        rules: {
            Nom: 'required',
            Mail: {
                required: true,
                email: true,

            },
            //highlight: false,
        },
        messages: {
            Nom: 'This field is required',
            Mail: 'Enter a valid email'
        },
        submitHandler: function (form) {
            //form.submit();si on active le submit cela va recharger la page index
            SaveAddClient();
        }
    });

//pour annuler le load de la page index une fois je clique sur submit
//$('form').submit(function (e) {
//    e.preventDefault();
//});

$('form').submit(function (e) {
        e.preventDefault();
            //Exemple des testes niveau javascript
            err = false;
            //var first_name = $('#idNomClient').val();
            ////var last_name = $('#last_name').val();
            //var email = $('#idMailClient').val();
            //var ville = $('#idVille').val();
            //var famille = $('#idFamille').val();
            //var contact = $('#iDContact').val();

            //$(".error").remove();
            //$(".ValidationMessage").hide();
            //alert("e2 ");
            //if (first_name.length < 1) {
            //    $('#idNomClient').after('<span class="error text-danger">This field is required</span>');
            //    err = true;
            //}



            //if (email.length < 1) {
            //    $('#idMailClient').after('<span class="error text-danger">This field is required</span>');
            //    err = true;
            //} else {
            //    var regEx = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;

            //      var validEmail = regEx.test(email);
            //      if (!validEmail) {
            //          $('#idMailClient').after('<span class="error text-danger">Enter a valid email</span>');
            //          err = true;
            //      }
            //}

            //alert("e1 " + err);
            //if (err == false) { SaveAddClient(); }

//secend Exemple
        //$("#addClientForm").validate();
        //var validator = #("#addClientForm").validate();
        //validator.form();

});
//-----------------------------------------------------------------------------
    //RegisterAjaxEvents();
    //setInterval(function () {
    //    //alert("Hello")
    //    Window.location = "./Login";
    //    ;
    //}, 3000);
        //alert("ddddd");
    //debugger
    $.ajax({
        type: "Get",
        dataType: 'json',
        url: "/Clients/GetlisteClient",
        success: function (data) {
            ReloadClientTable(data.clients);
        }
    });
    //ReloadClientTable();
    $("#Chercher").focus(function () {
        $("#Chercher").val("");
    });
});
var urls = null;
function SetActions(actions) {
urls = actions;
}
function valuesSharch() {
var ch = $("#Chercher").val();
alert(ch);
return ch;
}
function ReportChercher(repotType) {
alert(repotType);
//debugger
    searchValue = $("#Chercher").val();
    //std.repotType = $("#idPdf").val();
            $.ajax({
                type: "POST",
                url:  '@Url.Action("SaveFiltre", "Clients")',
                data: JSON.stringify({ 'searchValue': searchValue}),
                dataType: "html",
                contentType: "application/json; charset=utf-8",
                success: function () {
                    action = "@Url.Action("Report", "Clients")";
                    alert(repotType);
                    action += "?searchValue=" + searchValue  + "&repotType=" + repotType;
                    window.location.href = action;
                    //window.open('', '_new').
                },
                error: function () {
                    alert("Error while inserting data");
                }
    });
            return false;
}



function SaveAddClient() {
//alert("save save");
var nom = $("#idNomClient").val();
var Adresse = $("#idAdresseClient").val();
var IdFamille = $("#idIdFamilleClient").val();
var Tbl_Ville_id = $("#idIdVilleClient").val();
var IDContact = $("#idIDContactClient").val();
var Mail = $("#idMailClient").val();
var telephone1 = $("#idtelephone1Client").val();
var Gsm = $("#idGsmClient").val();
var fax = $("#idFaxClient").val();
var Cnss = $("#idCnssClient").val();
var idf = $("#ididfClient").val();
var Ice = $("#idIceClient").val();
var Teleph = $("#idTelephClient").val();
debugger
let dataObject = JSON.stringify({
    'Nom': nom,
    'Adresse': Adresse,
    'Tbl_Famille_Clt_Id': IdFamille,
    'Tbl_Ville_id': Tbl_Ville_id,
    'IDContact': IDContact,
    'Mail': Mail,
    'telephone1': telephone1,
    'Gsm': Gsm,
    'fax': fax,
    'Cnss': Cnss,
    'idf': idf,
    'Ice': Ice,
    'Teleph': Teleph
});
//var mydata = $("#addClientForm").serialize();
//Send the JSON array to Controller using AJAX.
//validation coté client
    //$("#addClientForm").removeData("validator");
    //$("#addClientForm").removeData("unobtrusiveValidation");
    //$.validator.unobtrusive.parse("#addClientForm");
    //debugger
    //alert($("#addClientForm").valid());
//$('input[name=teamName]')

//if (err == false) {
if ($("#addClientForm").valid()) {
    //alert("ddddd");
    $.ajax({
        type: "Post",
        dataType: 'json',
            //url: './SaveClient',
        url: "@Url.Action("SaveClient", "Clients")",
        data: dataObject,   /*mydata,*/
        contentType: 'application/json; charset=utf-8',
        success: function (res) {
        if (res.Success) {
            $("#idNomClient").val("");
            $("#idAdresseClient").val("");
            $("#idMailClient").val("");
            $("#idtelephone1Client").val("");
            $("#idGsmClient").val("");
            $("#idFaxClient").val("");
            $("#idCnssClient").val("");
            $("#ididfClient").val("");
            $("#idIceClient").val("");
            $("#idTelephClient").val("");
            //$("#addClientModal").hide();
            $('#addClientModal').modal('hide');
            //console.log(res);
            swal("Enregistrement effectué avec succès !", "", "success");
            ReloadClientTable(res.clients);
        } else {
            //REPENSE DU ESRVEUR
            console.log(res);
            swal("Échec du Sauvegarde ,Veuillez verifier vos données,Merci !", "", "error");
        }
        //if (clients != null && clients != false) {
        //alert(res.clients);
        //debugger
        // window.location.href = urls.GetFonds;
        //on doit vider les inputs
        },
        error: function (res) {
            //alert(res);
            console.log(res);
            swal("Échec du Sauvegarde_ajax !", "", "error");
        }

        });

    } else {
        //VALIDATION COTE CLIENT
        swal(" Veuillez verifier vos données, Merci!", "", "error");
    }

}
function Annuler() {
$("#addClientModal").hide();
}
//function Close() {
//    //alert("close");
//    $("#idNomClient").val("");
//    $("#idAdresseClient").val("");
//    $("#idMailClient").val("");
//    $("#idtelephone1Client").val("");
//    $("#idGsmClient").val("");
//    $("#idFaxClient").val("");
//    $("#idCnssClient").val("");
//    $("#ididfClient").val("");
//    $("#idIceClient").val("");
//    $("#idTelephClient").val("");
//    $('#idNomClient').show();
//    //$("#idNomClient").style.display = "block";
//    //$("#addClientModal").removeData("validator");
//    //$("#addClientModal").removeData("unobtrusiveValidation");
//    //$.validator.unobtrusive.parse("#addClientModal");

//    //jQuery("#addClientForm").validate().settings.ignore = "";
//    //$("form").data("validator").settings.ignore = ":hidden:not(#myitem)";
//    //$.validator.setDefaults({ ignore: '' });
//    //$("#addClientModal").hide();
//}

//SaveClient
function ChercherClient() {
var ch = $("#Chercher").val();
alert("dddd"+ ch);
    //if ((ch != null) && (ch != "Chercher") && (ch != "")) {
    $.ajax({
        type: "Get",
        dataType: 'json',
        //data: ch,
        //url: "@Url.Action("Chercher", "Clients")/" + ch + ",
        url: '/Clients/Chercher/?ch=' + ch,
        //data: ch,
        contentType: 'application/json; charset=utf-8',
        success: function (data) {
            if (data.clients != null || data.clients != false) {
                //alert(data.clients);
                // window.location.href = urls.GetFonds;
                //on doit vider les inputs
                $("#chercherClient").val("");
                ReloadClientTable(data.clients);
            }
        },
        error: function (data) {
            //alert(response);
            console.log(data);
            //swal("Acune information à afficher", "", "error");
        }
    });


//} else {
//    swal("Veuillez entrer une valeur à chercher", "", "error");
//}

}

function Delete(id) {
    if (confirm("Etes-vous sur de vouloir supprimer ce client")) {
            $.ajax({
                type: "Post",
                dataType: 'json',
                url: "@Url.Action("Delete", "Clients")/" + id,
                success: function (data) {
                    if (data.IsDeleted) {
                        //debugger
                        //  table.ajax.reload();
                            ReloadClientTable(data.clients);
                        //ReloadClientTable();
                            swal("Suppression effectuée avec succès !", "", "success");
                            }
                },
                error: function (data) {
                    swal("Impossible d'effectué la supression !", "", "error");
                }
                    });
    }
}

function EditClients(id) {
//var url = $(this).data("url");
    $.ajax({
    type: "Get",
    dataType:'json',
        url: "@Url.Action("Edit", "Clients")/" + id,
            success: function (data) {
            //debugger
                //$('#editClientModal').html(data.model); // This should be an empty div where you can inject your new html (the partial view)
                var model = data.model;
                $('#idIdClientEdit').val(model.id);
                $('#idNomClientEdit').val(model.Nom);
                $('#idAdresseClientEdit').val(model.Adresse);
                $('#idMailClientEdit').val(model.Mail);
                $('#idtelephone1ClientEdit').val(model.telephone1);
                $('#idfaxClientEdit').val(model.fax);
                $('#idCnssClientEdit').val(model.Cnss);
                $('#ididfClientEdit').val(model.idf);
                $('#idIceClientEdit').val(model.Ice);
                $('#idGsmClientEdit').val(model.Gsm);
                //affiche le modal
                //pour ne pas afficher les messages au chargement du modal
                //var $el = $('#editClientModal');
                //$el.data('validator', null);
                //$.validator.unobtrusive.parse($el);
                //jQuery.noConflict();
                $('#editClientModal').modal('show')

                //$('#editClientModal').modal({

                //    draggable: true,
                //    autoOpen: false,
                //    resizable: true,
                //    model: true,
                //height: 350,
                //width: 200,

                //title: 'Modifier le  client SDSDFDF',
                //close: function () {
                //    //alert("close");
                //    $("#editClientModal").hide();
                // }
                //});
        }
    });
}
function SaveEditClients() {
var id =  $("#idIdClientEdit").val();
var nom = $("#idNomClientEdit").val();
var Adresse = $("#idAdresseClientEdit").val();
var IdFamille = $("#idIdFamilleClientEdit").val();
var Tbl_Ville_id = $("#idIdVilleClientEdit").val();
var IDContact = $("#idIDContactClientEdit").val();
var Mail = $("#idMailClientEdit").val();
var telephone1 = $("#idtelephone1ClientEdit").val();
var Gsm = $("#idGsmClientEdit").val();
var idf = $("#ididfClientEdit").val();
var cnss = $("#idCnssClientEdit").val();
var ice = $("#idIceClientEdit").val();

let dataObject = JSON.stringify({
    'Id':id,
    'Nom': nom,
    'Adresse': Adresse,
    'Tbl_Famille_Clt_Id': IdFamille,
    'Tbl_Ville_id': Tbl_Ville_id,
    'IDContact': IDContact,
    'Mail': Mail,
    'telephone1': telephone1,
    'Gsm': Gsm,
    'cnss': cnss,
    'ice': ice,

});
//if ($("#editClientForm").valid()) {
    //debugger
    //var url = $(this).data("url");
        $.ajax({
            type: "Post",
            dataType: 'json',
            data: dataObject,
            url: "@Url.Action("Edit", "Clients")",
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                if (data.IsUpdate) {
                    var list = data.clients;
                    $("#editClientModal").hide();
                    ReloadClientTable(list);
                    //ReloadClientTable();
                    swal("Modification effectuée avec succès !", "", "success");
                }
                if (!data.IsUpdate) {
                    swal("Échec du Sauvegarde !", "", "error");
                }

            },

            error: function (data) {
                alert("response");
                console.log(data);
                swal("Échec du Sauvegarde !", "", "error");
            }

            });
}
//}

function AddClient() {
//VIDER LES ERREURS
//$(".error").remove();
//$(".ValidationMessage").hide();
alert("Create0q");
//pour ne pas afficher les
$('#idIdClient').val("");
$('#idNomClient').val("");
$('#idAdresseClient').val("");
$('#idMailClient').val("");
$('#idtelephone1Client').val("");
$('#idfaxClient').val("");
$('#idCnssClient').val("");
$('#ididfClient').val("");
$('#idFaxClient').val("");
$('#idTelephClient').val("");
$('#idIceClient').val("");
$('#idGsmClient').val("");

// Init JQuery Validation for view
//$("addClientForm").removeData("validator");
//$("addClientForm").removeData("unobtrusiveValidation");
    //$.validator.unobtrusive.parse("addClientModal");
$.ajax({
    //cache: false,
    //modal: true,
    //autoOpen: true,
    type: "GET",
    dataType: 'json',
    url: '@Url.Action("AddCreate", "Clients")',
    //url: '/Clients/AddCreate',
    //data: dataObject,
    contentType: 'application/json; charset=utf-8',
    success: function (res) {

        if (res != null && res != false) {
            $("#addClientModal").modal({
                //autoOpen: true,
                height: 550,
                width: 700,
                resizable: false,
                title: 'Fiche client',
                close: function () {
                    alert("closeAA");
                    $("#addClientModal").hide();
                    //Popup.dialog('destory').remove();
                }
            });
            $("#addClientModal").open();
        }
    }
});
//$("#addClientModal").modal();
}
    </script>

}
